<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout/main}" lang="fr">

<head>
    <title th:text="${conge.id != null} ? 'Modifier une demande' : 'Nouvelle demande' + ' - RH √âl√©gance'">Demande de
        cong√©</title>
</head>

<body>
    <div layout:fragment="content">
        <!-- Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 th:text="${conge.id != null} ? 'Modifier la demande de cong√©' : 'Nouvelle demande de cong√©'">
                        Demande de cong√©</h1>
                    <p class="subtitle">Remplissez le formulaire ci-dessous</p>
                </div>
                <a th:href="@{/conges/list}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Retour
                </a>
            </div>
        </div>

        <!-- Alerts -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- Form Card -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-alt" style="margin-right: 12px;"></i>Informations de la demande
            </div>
            <form id="congeForm"
                th:action="${conge.id != null} ? @{/conges/update/{id}(id=${conge.id})} : @{/conges/create}"
                th:object="${conge}" method="post" style="padding: 32px;">

                <!-- Employ√© -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px;">
                    <!-- Pour ADMIN/RH : S√©lection avec recherche -->
                    <div sec:authorize="hasAnyRole('ADMIN', 'RH')" style="position: relative;">
                        <label class="form-label" for="employe">EMPLOY√â *</label>
                        <input type="text" id="searchEmploye" class="form-control"
                            placeholder="üîç Rechercher par nom ou matricule..." style="margin-bottom: 8px;"
                            autocomplete="off" onkeyup="filterEmployes()" />

                        <select id="employe" th:field="*{employe.id}" class="form-control" required size="8"
                            style="min-height: 200px;">
                            <option value="">-- S√©lectionner un employ√© --</option>
                            <option th:each="emp : ${employes}" th:value="${emp.id}"
                                th:text="${emp.prenom + ' ' + emp.nom + ' - ' + emp.matricule}"
                                th:attr="data-search=${(emp.prenom + ' ' + emp.nom + ' ' + emp.matricule).toLowerCase()}">
                            </option>
                        </select>

                        <script>
                            function filterEmployes() {
                                const input = document.getElementById('searchEmploye');
                                const select = document.getElementById('employe');
                                const filter = input.value.toLowerCase();
                                const options = select.getElementsByTagName('option');

                                for (let i = 0; i < options.length; i++) {
                                    const option = options[i];
                                    if (option.value === '') {
                                        option.style.display = '';
                                        continue;
                                    }

                                    const searchData = option.getAttribute('data-search') || '';
                                    if (searchData.indexOf(filter) > -1 || filter === '') {
                                        option.style.display = '';
                                    } else {
                                        option.style.display = 'none';
                                    }
                                }
                            }
                        </script>
                    </div>

                    <!-- Pour les autres : Affichage lecture seule -->
                    <div sec:authorize="!hasAnyRole('ADMIN', 'RH')" th:if="${currentEmploye != null}">
                        <label class="form-label">EMPLOY√â</label>
                        <input type="hidden" th:field="*{employe.id}" />
                        <div
                            style="display: flex; align-items: center; padding: 12px; background: #F5F5F5; border: 1px solid #E0E0E0; border-radius: 8px;">
                            <div class="avatar" style="width: 32px; height: 32px; font-size: 12px; margin-right: 12px;">
                                <span
                                    th:text="${currentEmploye.prenom.substring(0,1) + currentEmploye.nom.substring(0,1)}">JP</span>
                            </div>
                            <div>
                                <div style="font-weight: 500; color: #1A1A1A;"
                                    th:text="${currentEmploye.prenom + ' ' + currentEmploye.nom}">Jean Dupont</div>
                                <div style="font-size: 12px; color: #666666;" th:text="${currentEmploye.matricule}">
                                    MAT001</div>
                            </div>
                        </div>
                    </div>

                    <!-- Type de cong√© -->
                    <div>
                        <label class="form-label" for="typeConge">TYPE DE CONG√â *</label>
                        <select id="typeConge" th:field="*{typeConge}" class="form-control" required>
                            <option value="">-- S√©lectionner un type --</option>
                            <option value="CONGES_PAYES">Cong√©s pay√©s</option>
                            <option value="MALADIE">Maladie</option>
                            <option value="MATERNITE">Maternit√©</option>
                            <option value="PATERNITE">Paternit√©</option>
                            <option value="FORMATION">Formation</option>
                            <option value="SANS_SOLDE">Sans solde</option>
                        </select>
                    </div>
                </div>

                <!-- Dates -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; margin-bottom: 24px;">
                    <div>
                        <label class="form-label" for="dateDebut">DATE DE D√âBUT *</label>
                        <input type="date" id="dateDebut" th:field="*{dateDebut}" class="form-control" required />
                    </div>

                    <div>
                        <label class="form-label" for="dateFin">DATE DE FIN *</label>
                        <input type="date" id="dateFin" th:field="*{dateFin}" class="form-control" required />
                        <small id="dateError" class="text-danger" style="display:none;">La date de fin doit √™tre
                            post√©rieure ou √©gale √† la date de d√©but.</small>
                    </div>
                </div>

                <!-- Nombre de jours (cach√©, calcul√© automatiquement) -->
                <input type="hidden" id="nombreJours" th:field="*{nombreJours}" />

                <!-- Information nombre de jours calcul√© -->
                <div id="joursInfo"
                    style="display: none; padding: 16px; background: #E3F2FD; border-left: 4px solid #2196F3; border-radius: 8px; margin-bottom: 24px;">
                    <div style="display: flex; align-items: center;">
                        <i class="fas fa-info-circle" style="margin-right: 12px; color: #1565C0; font-size: 20px;"></i>
                        <div>
                            <div style="color: #1565C0; font-weight: 600; font-size: 14px;">Dur√©e calcul√©e</div>
                            <div style="color: #1976D2; font-size: 16px; font-weight: 500; margin-top: 4px;">
                                <span id="joursCalcules">0</span> jour(s)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motif -->
                <div style="margin-bottom: 32px;">
                    <label class="form-label" for="motif">MOTIF</label>
                    <textarea id="motif" th:field="*{motif}" class="form-control" rows="4"
                        placeholder="D√©crivez bri√®vement le motif de votre demande..."
                        style="resize: vertical;"></textarea>
                </div>

                <!-- Boutons d'action -->
                <div style="display: flex; gap: 12px; padding-top: 24px; border-top: 1px solid #E0E0E0;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check" style="margin-right: 8px;"></i>
                        <span th:text="${conge.id != null} ? 'Mettre √† jour' : 'Cr√©er la demande'">Enregistrer</span>
                    </button>
                    <a th:href="@{/conges/list}" class="btn btn-secondary">
                        <i class="fas fa-times" style="margin-right: 8px;"></i>Annuler
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script layout:fragment="scripts">
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('congeForm');
            const dateDebutInput = document.getElementById('dateDebut');
            const dateFinInput = document.getElementById('dateFin');
            const dateError = document.getElementById('dateError');
            const nombreJoursInput = document.getElementById('nombreJours');
            const joursInfo = document.getElementById('joursInfo');
            const joursCalcules = document.getElementById('joursCalcules');

            // Calcul automatique du nombre de jours
            function calculerJours() {
                const dateDebut = dateDebutInput.value;
                const dateFin = dateFinInput.value;

                if (dateDebut && dateFin) {
                    const debut = new Date(dateDebut);
                    const fin = new Date(dateFin);

                    if (fin >= debut) {
                        const diffTime = Math.abs(fin - debut);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                        nombreJoursInput.value = diffDays;
                        joursCalcules.textContent = diffDays;
                        joursInfo.style.display = 'block';
                        dateError.style.display = 'none';
                    } else {
                        nombreJoursInput.value = '';
                        joursInfo.style.display = 'none';
                        dateError.style.display = 'block';
                    }
                } else {
                    nombreJoursInput.value = '';
                    joursInfo.style.display = 'none';
                    dateError.style.display = 'none';
                }
            }

            // Ajouter les √©v√©nements de calcul
            if (dateDebutInput) {
                dateDebutInput.addEventListener('change', calculerJours);
            }
            if (dateFinInput) {
                dateFinInput.addEventListener('change', calculerJours);
            }

            // Validation √† la soumission
            form.addEventListener('submit', function (event) {
                const dateDebut = dateDebutInput.value;
                const dateFin = dateFinInput.value;

                if (dateDebut && dateFin) {
                    const debut = new Date(dateDebut);
                    const fin = new Date(dateFin);

                    if (fin < debut) {
                        event.preventDefault();
                        dateError.style.display = 'block';
                    }
                }
            });

            // Calculer au chargement si les dates sont d√©j√† pr√©sentes
            calculerJours();

            // La recherche d'employ√© est maintenant g√©r√©e par filterEmployes() inline dans le HTML
        });
    </script>
</body>

</html>