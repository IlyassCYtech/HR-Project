<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/main}" lang="fr">

<head>
    <title th:text="${departement.id != null ? 'Modifier' : 'Nouveau'} + ' Département - RH Élégance'">Département
    </title>
</head>

<body>
    <div layout:fragment="content">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin-bottom: 8px;"
                        th:text="${departement.id != null ? 'Modifier le département' : 'Nouveau département'}">
                        Nouveau département
                    </h1>
                    <p class="subtitle"
                        th:text="${departement.id != null ? 'Mettre à jour les informations du département' : 'Créer un nouveau département'}">
                        Créer un nouveau département
                    </p>
                </div>
                <a th:href="@{/departements/list}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Retour
                </a>
            </div>
        </div>

        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
            <span th:text="${error}"></span>
        </div>

        <form id="departementForm"
            th:action="@{${departement.id != null ? '/departements/update/' + departement.id : '/departements/create'}}"
            method="post" th:object="${departement}">

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-building" style="margin-right: 12px;"></i>Informations du département
                </div>
                <div style="padding: 32px;">
                    <div style="margin-bottom: 24px;">
                        <label class="form-label" for="nom">
                            NOM DU DÉPARTEMENT <span style="color: #C5A572;">*</span>
                        </label>
                        <input type="text" id="nom" th:field="*{nom}" class="form-control" required
                            placeholder="Ex: Ressources Humaines" />
                        <small id="nomError" class="text-danger" style="display:none;">Le nom ne doit contenir que des
                            lettres.</small>
                        <small th:if="${departement.id != null}"
                            style="color: #666666; display: block; margin-top: 4px;">
                            Code du département : <span
                                style="font-family: 'Courier New', monospace; color: #C5A572; font-weight: 600;"
                                th:text="'DEPT-' + ${departement.id}">DEPT-1</span>
                        </small>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label class="form-label" for="description">
                            DESCRIPTION
                        </label>
                        <textarea id="description" th:field="*{description}" class="form-control" rows="4"
                            placeholder="Description des missions et responsabilités du département"></textarea>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <div>
                            <label class="form-label" for="chefDepartementId">
                                RESPONSABLE
                            </label>
                            <select id="chefDepartementId" name="chefDepartementId" class="form-control">
                                <option value="">-- Sélectionner un responsable --</option>
                                <option th:each="emp : ${employes}" th:value="${emp.id}"
                                    th:text="${emp.prenom + ' ' + emp.nom + ' - ' + emp.poste}"
                                    th:selected="${departement.chefDepartement != null && departement.chefDepartement.id == emp.id}">
                                    Jean Dupont - Directeur
                                </option>
                            </select>
                        </div>

                        <div>
                            <label class="form-label" for="budget">
                                BUDGET ANNUEL (€)
                            </label>
                            <input type="number" id="budget" th:field="*{budget}" class="form-control" min="0"
                                step="1000" placeholder="Ex: 500000" />
                            <small id="budgetError" class="text-danger" style="display:none;">Le budget doit être un
                                montant positif.</small>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save" style="margin-right: 8px;"></i>Enregistrer
                </button>
                <a th:href="@{/departements/list}" class="btn btn-secondary">
                    Annuler
                </a>
            </div>
        </form>

        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const form = document.getElementById('departementForm');
                const nomInput = document.getElementById('nom');
                const budgetInput = document.getElementById('budget');
                const nomError = document.getElementById('nomError');
                const budgetError = document.getElementById('budgetError');

                // Regex pour lettres uniquement (avec accents, espaces et tirets)
                const nameRegex = /^[a-zA-ZÀ-ÿ\s\-]+$/;

                form.addEventListener('submit', function (event) {
                    let isValid = true;

                    // Validation Nom
                    if (!nameRegex.test(nomInput.value)) {
                        nomError.style.display = 'block';
                        isValid = false;
                    } else {
                        nomError.style.display = 'none';
                    }

                    // Validation Budget
                    if (budgetInput.value && parseFloat(budgetInput.value) < 0) {
                        budgetError.style.display = 'block';
                        isValid = false;
                    } else {
                        budgetError.style.display = 'none';
                    }

                    if (!isValid) {
                        event.preventDefault();
                    }
                });
            });
        </script>
    </div>
</body>

</html>