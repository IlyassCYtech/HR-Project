<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout/main}" lang="fr">

<head>
    <title>Modifier Fiche de Paie - RH Élégance</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="header">
            <h1>Modification de la fiche de paie</h1>
            <p class="subtitle">
                <span th:text="${fichePaie.employe.prenom + ' ' + fichePaie.employe.nom}">Employé</span> •
                <span th:text="${fichePaie.mois + '/' + fichePaie.annee}">Période</span>
            </p>
        </div>

        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
            <span th:text="${error}"></span>
        </div>

        <div class="card">
            <form id="fichePaieForm" th:action="@{/fiches-paie/update/{id}(id=${fichePaie.id})}"
                th:object="${fichePaie}" method="post">

                <!-- Champ caché pour conserver l'employé -->
                <input type="hidden" th:field="*{employe}" />

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="mois">MOIS *</label>
                        <select id="mois" th:field="*{mois}" class="form-control" required>
                            <option value="1">Janvier</option>
                            <option value="2">Février</option>
                            <option value="3">Mars</option>
                            <option value="4">Avril</option>
                            <option value="5">Mai</option>
                            <option value="6">Juin</option>
                            <option value="7">Juillet</option>
                            <option value="8">Août</option>
                            <option value="9">Septembre</option>
                            <option value="10">Octobre</option>
                            <option value="11">Novembre</option>
                            <option value="12">Décembre</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="annee">ANNÉE *</label>
                        <input type="number" id="annee" th:field="*{annee}" class="form-control" min="2020" max="2030"
                            required />
                        <small id="anneeError" class="text-danger" style="display:none;">L'année doit être comprise
                            entre 2020 et 2030.</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="salaireBase">SALAIRE DE BASE (€) *</label>
                        <input type="number" id="salaireBase" th:field="*{salaireBase}" class="form-control" step="0.01"
                            min="0" required />
                        <small id="salaireError" class="text-danger" style="display:none;">Le salaire doit être
                            positif.</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="primePerformance">PRIME DE PERFORMANCE (€)</label>
                        <input type="number" id="primePerformance" th:field="*{primePerformance}" class="form-control"
                            step="0.01" min="0" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="primeAnciennete">PRIME D'ANCIENNETÉ (€)</label>
                        <input type="number" id="primeAnciennete" th:field="*{primeAnciennete}" class="form-control"
                            step="0.01" min="0" />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="autresPrimes">AUTRES PRIMES (€)</label>
                        <input type="number" id="autresPrimes" th:field="*{autresPrimes}" class="form-control"
                            step="0.01" min="0" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="heuresSupplementaires">HEURES SUPPLÉMENTAIRES</label>
                        <input type="number" id="heuresSupplementaires" th:field="*{heuresSupplementaires}"
                            class="form-control" step="0.5" min="0" />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="tauxHoraireSup">TAUX HORAIRE SUP. (€)</label>
                        <input type="number" id="tauxHoraireSup" th:field="*{tauxHoraireSup}" class="form-control"
                            step="0.01" min="0" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="cotisationsSociales">COTISATIONS SOCIALES (€)</label>
                        <input type="number" id="cotisationsSociales" th:field="*{cotisationsSociales}"
                            class="form-control" step="0.01" min="0" />
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="impots">IMPÔTS (€)</label>
                        <input type="number" id="impots" th:field="*{impots}" class="form-control" step="0.01"
                            min="0" />
                    </div>
                </div>

                <small id="negativeError" class="text-danger" style="display:none; margin-top: 10px;">Tous les montants
                    doivent être positifs ou nuls.</small>

                <div style="display: flex; gap: 12px; margin-top: 32px;">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save" style="margin-right: 8px;"></i>Enregistrer les modifications
                    </button>
                    <a th:href="@{/fiches-paie/list}" class="btn" style="background: #E0E0E0; color: #1A1A1A;">
                        <i class="fas fa-times" style="margin-right: 8px;"></i>Annuler
                    </a>
                </div>
            </form>

            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const form = document.getElementById('fichePaieForm');
                    const anneeInput = document.getElementById('annee');
                    const salaireInput = document.getElementById('salaireBase');

                    const anneeError = document.getElementById('anneeError');
                    const salaireError = document.getElementById('salaireError');
                    const negativeError = document.getElementById('negativeError');

                    // Liste de tous les champs numériques
                    const numberInputs = form.querySelectorAll('input[type="number"]');

                    form.addEventListener('submit', function (event) {
                        let isValid = true;
                        let hasNegative = false;

                        // Validation Année
                        const annee = parseInt(anneeInput.value);
                        if (annee < 2020 || annee > 2030) {
                            anneeError.style.display = 'block';
                            isValid = false;
                        } else {
                            anneeError.style.display = 'none';
                        }

                        // Validation Salaire
                        if (parseFloat(salaireInput.value) < 0) {
                            salaireError.style.display = 'block';
                            isValid = false;
                        } else {
                            salaireError.style.display = 'none';
                        }

                        // Validation de tous les champs numériques pour éviter les négatifs
                        numberInputs.forEach(input => {
                            if (input.value && parseFloat(input.value) < 0) {
                                hasNegative = true;
                                input.style.borderColor = '#dc3545';
                            } else {
                                input.style.borderColor = ''; // Reset
                            }
                        });

                        if (hasNegative) {
                            negativeError.style.display = 'block';
                            isValid = false;
                        } else {
                            negativeError.style.display = 'none';
                        }

                        if (!isValid) {
                            event.preventDefault();
                        }
                    });
                });
            </script>
        </div>
    </div>
</body>

</html>