<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}" lang="fr">
<head>
    <title th:text="${departement.nom} + ' - RH Élégance'">Département</title>
</head>
<body>
<div layout:fragment="content">
    <div class="header">
        <div style="display: flex; align-items: center; gap: 24px;">
            <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #C5A572 0%, #A08555 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-building" style="font-size: 36px; color: white;"></i>
            </div>
            <div style="flex: 1;">
                <h1 style="margin-bottom: 8px;" th:text="${departement.nom}">Département IT</h1>
                <p class="subtitle">
                    Code: <span style="font-family: 'Courier New', monospace; color: #C5A572; font-weight: 600;" 
                                th:text="'DEPT-' + ${departement.id}">DEPT-1</span>
                </p>
            </div>
            <div style="display: flex; gap: 12px;">
                <a th:href="@{/departements/form/{id}(id=${departement.id})}" 
                   sec:authorize="hasAnyRole('ADMIN', 'RH')"
                   class="btn btn-primary">
                    <i class="fas fa-edit" style="margin-right: 8px;"></i>Modifier
                </a>
                <a th:href="@{/departements/form/{id}(id=${departement.id})}" 
                   sec:authorize="hasRole('CHEF_DEPT')"
                   th:if="${canEditDepartement}"
                   class="btn btn-primary">
                    <i class="fas fa-edit" style="margin-right: 8px;"></i>Modifier
                </a>
                <a th:href="@{/departements/delete/{id}(id=${departement.id})}" 
                   sec:authorize="hasAnyRole('ADMIN', 'RH')"
                   class="btn btn-danger"
                   th:attr="onclick='return confirm(\'⚠️ CONFIRMATION DE SUPPRESSION ⚠️\n\nVoulez-vous vraiment SUPPRIMER le département \\\''+${departement.nom}+'\\\' ?\n\n⚡ SUPPRESSION EN CASCADE :\n• ' + ${nbEmployes} + ' employé(s) seront retirés automatiquement\n• Les projets liés seront affectés\n• Cette action est IRRÉVERSIBLE\n\nConfirmer la suppression ?\');'">
                    <i class="fas fa-trash" style="margin-right: 8px;"></i>Supprimer
                </a>
                <a th:href="@{/departements/list}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Retour
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr); margin-bottom: 32px;">
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <h4 th:text="${nbEmployes}">0</h4>
            <p>Employés</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-euro-sign"></i>
            <h4>
                <span th:if="${!#authorization.expression('hasAnyRole(''ADMIN'', ''RH'', ''CHEF_DEPT'')')}" style="color: #999;">
                    <i class="fas fa-lock"></i>
                </span>
                <span th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'', ''CHEF_DEPT'')')}"
                      th:text="${departement.budget != null && departement.budget > 0 ? #numbers.formatDecimal(departement.budget, 0, 'COMMA', 0, 'POINT') + ' €' : 'Non défini'}">
                    100,000 €
                </span>
            </h4>
            <p th:text="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'', ''CHEF_DEPT'')') ? 'Budget annuel' : 'Confidentiel'}">Budget annuel</p>
        </div>
        <div class="stat-card">
            <i class="fas fa-project-diagram"></i>
            <h4 th:text="${nbProjets ?: 0}">0</h4>
            <p>Projets</p>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
        <!-- Informations générales -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle" style="margin-right: 12px;"></i>Informations générales
            </div>
            <div style="padding: 32px;">
                <div style="margin-bottom: 24px;">
                    <label class="form-label">CODE</label>
                    <p style="font-family: 'Courier New', monospace; font-size: 18px; color: #C5A572; font-weight: 600;"
                       th:text="'DEPT-' + ${departement.id}">DEPT-1</p>
                </div>
                <div style="margin-bottom: 24px;">
                    <label class="form-label">DESCRIPTION</label>
                    <p style="font-size: 14px; color: #1A1A1A; line-height: 1.6;"
                       th:text="${departement.description != null && !#strings.isEmpty(departement.description) ? departement.description : 'Aucune description'}">
                        Description du département
                    </p>
                </div>
                <div>
                    <label class="form-label">RESPONSABLE</label>
                    <div th:if="${departement.chefDepartement != null}" style="display: flex; align-items: center; gap: 12px; margin-top: 12px;">
                        <div class="avatar"
                             th:text="${#strings.substring(departement.chefDepartement.prenom, 0, 1) + #strings.substring(departement.chefDepartement.nom, 0, 1)}">JD</div>
                        <div>
                            <div style="font-weight: 600; color: #1A1A1A;">
                                <a th:href="@{/employes/show/{id}(id=${departement.chefDepartement.id})}"
                                   style="color: #C5A572; text-decoration: none;"
                                   th:text="${departement.chefDepartement.prenom + ' ' + departement.chefDepartement.nom}">Jean Dupont</a>
                            </div>
                            <div style="font-size: 12px; color: #666666;"
                                 th:text="${departement.chefDepartement.poste}">Directeur</div>
                        </div>
                    </div>
                    <p th:if="${departement.chefDepartement == null}" style="color: #999999; margin-top: 8px;">
                        Aucun responsable assigné
                    </p>
                </div>
            </div>
        </div>

        <!-- Budget -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-chart-line" style="margin-right: 12px;"></i>Budget
            </div>
            <div style="padding: 32px;">
                <div style="margin-bottom: 24px;">
                    <label class="form-label">BUDGET ANNUEL</label>
                    <p th:if="${!#authorization.expression('hasAnyRole(''ADMIN'', ''RH'', ''CHEF_DEPT'')')}" 
                       style="font-size: 16px; color: #999999; font-style: italic; margin-top: 8px;">
                        <i class="fas fa-lock" style="margin-right: 8px;"></i>Confidentiel
                    </p>
                    <p th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'', ''CHEF_DEPT'')')}" 
                       style="font-size: 28px; color: #1A1A1A; font-weight: 600; margin-top: 8px;"
                       th:text="${departement.budget != null && departement.budget > 0 ? #numbers.formatDecimal(departement.budget, 0, 'COMMA', 0, 'POINT') + ' €' : 'Non défini'}">
                        100,000 €
                    </p>
                </div>
                <div th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'', ''CHEF_DEPT'')') && departement.budget != null && departement.budget > 0}"
                     style="padding: 16px; background: #F5F5F5; border-radius: 8px;">
                    <div style="margin-bottom: 8px;">
                        <label class="form-label">BUDGET MENSUEL MOYEN</label>
                        <p style="font-size: 18px; color: #1A1A1A; font-weight: 600;"
                           th:text="${#numbers.formatDecimal(departement.budget / 12, 0, 'COMMA', 0, 'POINT') + ' €'}">8,333 €</p>
                    </div>
                    <div>
                        <label class="form-label">BUDGET PAR EMPLOYÉ</label>
                        <p style="font-size: 18px; color: #1A1A1A; font-weight: 600;"
                           th:text="${nbEmployes > 0 ? #numbers.formatDecimal(departement.budget / nbEmployes, 0, 'COMMA', 0, 'POINT') + ' €' : 'N/A'}">N/A</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des employés -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <i class="fas fa-users" style="margin-right: 12px;"></i>Employés du département
            </div>
            <button sec:authorize="hasAnyRole('ADMIN', 'RH', 'CHEF_DEPT')"
                    id="btnAffecterEmploye"
                    class="btn btn-primary btn-sm">
                <i class="fas fa-user-plus" style="margin-right: 8px;"></i>Affecter un employé
            </button>
        </div>
        
        <div th:if="${employes != null && !employes.empty}">
            <table class="table-elegant">
                <thead>
                    <tr>
                        <th>EMPLOYÉ</th>
                        <th>POSTE</th>
                        <th>GRADE</th>
                        <th>SALAIRE</th>
                        <th style="text-align: center;">STATUT</th>
                        <th style="text-align: center;">ACTIONS</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="emp : ${employes}">
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="avatar"
                                     th:text="${#strings.substring(emp.prenom, 0, 1) + #strings.substring(emp.nom, 0, 1)}">JD</div>
                                <div>
                                    <div style="font-weight: 600; color: #1A1A1A;"
                                         th:text="${emp.prenom + ' ' + emp.nom}">Jean Dupont</div>
                                    <div style="font-size: 12px; color: #666666; font-family: 'Courier New', monospace;"
                                         th:text="${emp.matricule}">EMP001</div>
                                </div>
                            </div>
                        </td>
                        <td th:text="${emp.poste}">Développeur</td>
                        <td th:text="${emp.grade}">SENIOR</td>
                        <td style="font-weight: 600;">
                            <span th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}"
                                  th:text="${#numbers.formatDecimal(emp.salaireBase, 0, 'COMMA', 0, 'POINT') + ' €'}">45,000 €</span>
                            <span th:if="${!#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}">Indisponible</span>
                        </td>
                        <td style="text-align: center;">
                            <span th:if="${emp.statut == 'ACTIF'}" class="badge-elegant badge-success">Actif</span>
                            <span th:unless="${emp.statut == 'ACTIF'}" class="badge-elegant badge-secondary"
                                  th:text="${emp.statut}">Inactif</span>
                        </td>
                        <td style="text-align: center;">
                            <div style="display: flex; gap: 8px; justify-content: center;">
                                <a th:href="@{/employes/form/{id}(id=${emp.id})}" 
                                   sec:authorize="hasAnyRole('ADMIN', 'RH', 'CHEF_DEPT')"
                                   class="btn btn-primary btn-sm" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a th:href="@{/employes/show/{id}(id=${emp.id})}" 
                                   class="btn btn-outline btn-sm" title="Voir détails">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a th:href="@{/departements/retirer-employe/{departementId}/{employeId}(departementId=${departement.id}, employeId=${emp.id})}"
                                   sec:authorize="hasAnyRole('ADMIN', 'RH')"
                                   class="btn btn-danger btn-sm" 
                                   title="Retirer du département"
                                   th:attr="onclick='return confirm(\'⚠️ Voulez-vous vraiment retirer ' + ${emp.prenom} + ' ' + ${emp.nom} + ' du département ' + ${departement.nom} + ' ?\');'">
                                    <i class="fas fa-user-minus"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div th:if="${employes == null || employes.empty}" 
             style="padding: 60px 40px; text-align: center;">
            <i class="fas fa-users" style="font-size: 48px; color: #E0E0E0; margin-bottom: 16px;"></i>
            <p style="color: #666666;">Aucun employé dans ce département</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="modalAffecterEmploye" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999;">
        <div class="card" style="width: 500px; max-height: 80vh; overflow-y: auto;">
            <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <i class="fas fa-user-plus" style="margin-right: 12px;"></i>Affecter un employé au département
                </div>
                <button type="button" id="btnFermerModal" 
                        style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">×</button>
            </div>
            <form th:action="@{/departements/affecter-employe}" method="POST" style="padding: 24px;">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <input type="hidden" name="departementId" th:value="${departement.id}">
                
                <div style="margin-bottom: 24px;">
                    <label class="form-label">EMPLOYÉ <span style="color: #DC3545;">*</span></label>
                    <th:block th:if="${#lists.isEmpty(employesSansService)}">
                        <div style="color: #DC3545; margin-bottom: 12px;">
                            <i class="fas fa-exclamation-triangle"></i> Aucun employé disponible à affecter !
                        </div>
                    </th:block>
                    <select name="employeId" class="form-control" required style="padding: 12px; font-size: 14px;"
                            th:disabled="${#lists.isEmpty(employesSansService)}">
                        <option value="">-- Sélectionner un employé --</option>
                        <option th:each="emp : ${employesSansService}" 
                                th:value="${emp.id}"
                                th:text="${emp.matricule + ' - ' + emp.prenom + ' ' + emp.nom + (emp.poste != null ? ' (' + emp.poste + ')' : '')}">
                            EMP001 - Jean Dupont (Développeur)
                        </option>
                    </select>
                    <small style="color: #666; font-size: 12px; display: block; margin-top: 8px;">
                        <i class="fas fa-info-circle"></i> Seuls les employés sans département sont affichés
                    </small>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" id="btnAnnuler" class="btn btn-secondary">Annuler</button>
                    <button type="submit" class="btn btn-primary" th:disabled="${#lists.isEmpty(employesSansService)}">
                        <i class="fas fa-check" style="margin-right: 8px;"></i>Affecter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script -->
    <script th:inline="javascript">
        (function() {
            window.addEventListener('load', function() {
                console.log('✅ Script chargé');
                
                var btnAffecter = document.getElementById('btnAffecterEmploye');
                var modal = document.getElementById('modalAffecterEmploye');
                var btnFermer = document.getElementById('btnFermerModal');
                var btnAnnuler = document.getElementById('btnAnnuler');
                
                console.log('Bouton:', btnAffecter ? '✓ Trouvé' : '✗ Non trouvé');
                console.log('Modal:', modal ? '✓ Trouvé' : '✗ Non trouvé');
                
                if (btnAffecter && modal) {
                    btnAffecter.onclick = function() {
                        console.log('✓ Ouverture modal');
                        modal.style.display = 'flex';
                    };
                    
                    if (btnFermer) {
                        btnFermer.onclick = function() {
                            modal.style.display = 'none';
                        };
                    }
                    
                    if (btnAnnuler) {
                        btnAnnuler.onclick = function() {
                            modal.style.display = 'none';
                        };
                    }
                    
                    console.log('✅ Modal configuré');
                } else {
                    console.error('❌ Erreur configuration modal');
                }
            });
        })();
    </script>

</div>
</body>
</html>