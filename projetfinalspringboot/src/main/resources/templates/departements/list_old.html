<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}" lang="fr">

<head>
    <title>Gestion des Départements</title>
</head>
<body>
<div layout:fragment="content">
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">

            <div><body><body>

                <h1 style="margin-bottom: 8px;">Départements</h1>

                <p class="subtitle">Gestion de l'organisation et des départements</p><div layout:fragment="content">    <div layout:fragment="content">

            </div>

            <a th:href="@{/departements/form}"     <div class="header">        <!-- Page Header -->

               sec:authorize="hasAnyRole('ADMIN', 'RH')"

               class="btn btn-primary">        <div style="display: flex; justify-content: space-between; align-items: center;">        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">

                <i class="fas fa-plus" style="margin-right: 8px;"></i>Nouveau département

            </a>            <div>            <div>

        </div>

    </div>                <h1 style="margin-bottom: 8px;">Départements</h1>                <h1 style="font-family: 'Playfair Display', serif; font-size: 28px; color: #1A1A1A; margin-bottom: 8px;">



    <div th:if="${message}" class="alert alert-success" role="alert">                <p class="subtitle">Gestion de l'organisation et des départements</p>                    Départements

        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>

        <span th:text="${message}"></span>            </div>                </h1>

    </div>

            <a th:href="@{/departements/form}"                 <p style="color: #666666; font-size: 14px;">

    <div th:if="${error}" class="alert alert-danger" role="alert">

        <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>               sec:authorize="hasAnyRole('ADMIN', 'RH')"                    Gestion de l'organisation et des départements

        <span th:text="${error}"></span>

    </div>               class="btn btn-primary">                </p>



    <div class="card">                <i class="fas fa-plus" style="margin-right: 8px;"></i>Nouveau département            </div>

        <div class="card-header">

            <i class="fas fa-building" style="margin-right: 12px;"></i>Liste des départements            </a>            <a sec:authorize="hasAnyRole('ADMIN', 'RH')"

        </div>

                </div>               th:href="@{/departements/form}" 

        <div th:if="${departements != null && !departements.empty}">

            <table class="table-elegant">    </div>               style="padding: 12px 24px; background: #C5A572; color: #FFFFFF; text-decoration: none; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">

                <thead>

                    <tr>                <i class="fas fa-plus" style="margin-right: 8px;"></i>Nouveau département

                        <th>CODE</th>

                        <th>NOM</th>    <div th:if="${message}" class="alert alert-success" role="alert">            </a>

                        <th>RESPONSABLE</th>

                        <th style="text-align: center;">EMPLOYÉS</th>        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>        </div>

                        <th>BUDGET ANNUEL</th>

                        <th style="text-align: center;">ACTIONS</th>        <span th:text="${message}"></span>

                    </tr>

                </thead>    </div>        <!-- Messages -->

                <tbody>

                    <tr th:each="dept : ${departements}">        <div th:if="${message}" style="padding: 16px 20px; margin-bottom: 24px; border-left: 3px solid #38A169; background: #F0FFF4; color: #22543D; font-size: 13px;">

                        <td>

                            <span style="font-family: 'Courier New', monospace; color: #C5A572; font-weight: 600; font-size: 14px;"    <div th:if="${error}" class="alert alert-danger" role="alert">            <i class="fas fa-check-circle" style="margin-right: 8px; color: #38A169;"></i>

                                  th:text="'DEPT-' + ${dept.id}">

                                DEPT-1        <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>            <span th:text="${message}"></span>

                            </span>

                        </td>        <span th:text="${error}"></span>        </div>

                        <td>

                            <div style="font-weight: 600; color: #1A1A1A; margin-bottom: 2px;"    </div>        <div th:if="${error}" style="padding: 16px 20px; margin-bottom: 24px; border-left: 3px solid #E53E3E; background: #FFF5F5; color: #742A2A; font-size: 13px;">

                                 th:text="${dept.nom}">

                                Département            <i class="fas fa-exclamation-circle" style="margin-right: 8px; color: #E53E3E;"></i>

                            </div>

                            <div th:if="${dept.description != null && !#strings.isEmpty(dept.description)}"     <div class="card">            <span th:text="${error}"></span>

                                 style="font-size: 12px; color: #666666; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"

                                 th:text="${dept.description}">        <div class="card-header">        </div>

                                Description

                            </div>            <i class="fas fa-building" style="margin-right: 12px;"></i>Liste des départements

                        </td>

                        <td>        </div>        <!-- Departments Table -->

                            <div th:if="${dept.chefDepartement != null}" style="display: flex; align-items: center; gap: 12px;">

                                <div class="avatar"                <div style="background: #FFFFFF; border: 1px solid #E0E0E0; overflow: hidden;">

                                     th:text="${#strings.substring(dept.chefDepartement.prenom, 0, 1) + #strings.substring(dept.chefDepartement.nom, 0, 1)}">

                                    JD        <div th:if="${departements != null && !departements.empty}">            <div style="padding: 20px 32px; border-bottom: 1px solid #E0E0E0; background: #FAFAFA;">

                                </div>

                                <div>            <table class="table-elegant">                <h2 style="font-family: 'Playfair Display', serif; font-size: 18px; color: #1A1A1A; margin: 0;">

                                    <div style="font-weight: 500; color: #1A1A1A;"

                                         th:text="${dept.chefDepartement.prenom + ' ' + dept.chefDepartement.nom}">                <thead>                    <i class="fas fa-building" style="margin-right: 12px; color: #C5A572;"></i>

                                        Chef

                                    </div>                    <tr>                    Liste des départements

                                    <div style="font-size: 12px; color: #666666;"

                                         th:text="${dept.chefDepartement.poste}">                        <th>CODE</th>                </h2>

                                        Poste

                                    </div>                        <th>NOM</th>            </div>

                                </div>

                            </div>                        <th>RESPONSABLE</th>            

                            <span th:unless="${dept.chefDepartement != null}" style="color: #999999;">Non assigné</span>

                        </td>                        <th style="text-align: center;">EMPLOYÉS</th>            <table style="width: 100%; border-collapse: collapse;">

                        <td style="text-align: center;">

                            <span style="display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 36px; background: #F5F5F5; border-radius: 8px; font-weight: 600; color: #1A1A1A;"                        <th>BUDGET ANNUEL</th>                <thead>

                                  th:text="${dept.employes != null ? dept.employes.size() : 0}">

                                0                        <th style="text-align: center;">ACTIONS</th>                    <tr style="background: #FAFAFA; border-bottom: 2px solid #E0E0E0;">

                            </span>

                        </td>                    </tr>                        <th style="text-align: left; padding: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #666666; font-weight: 600;">Code</th>

                        <td>

                            <span sec:authorize="hasRole('EMPLOYE') or hasRole('CHEF_PROJET')"                 </thead>                        <th style="text-align: left; padding: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #666666; font-weight: 600;">Nom</th>

                                  style="color: #999999; font-style: italic;">Indisponible</span>

                            <span sec:authorize="hasAnyRole('ADMIN', 'RH', 'CHEF_DEPT')"                 <tbody>                        <th style="text-align: left; padding: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #666666; font-weight: 600;">Responsable</th>

                                  th:if="${dept.budget != null && dept.budget > 0}" 

                                  style="font-weight: 600; color: #1A1A1A;"                    <tr th:each="dept : ${departements}">                        <th style="text-align: center; padding: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #666666; font-weight: 600;">Employés</th>

                                  th:text="${#numbers.formatDecimal(dept.budget, 1, 'COMMA', 0, 'POINT')} + ' €'">

                                0 €                        <td>                        <th style="text-align: left; padding: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #666666; font-weight: 600;">Budget Annuel</th>

                            </span>

                            <span sec:authorize="hasAnyRole('ADMIN', 'RH', 'CHEF_DEPT')"                             <span style="font-family: 'Courier New', monospace; color: #C5A572; font-weight: 600; font-size: 14px;"                        <th style="text-align: center; padding: 16px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #666666; font-weight: 600;">Actions</th>

                                  th:if="${dept.budget == null || dept.budget == 0}" 

                                  style="color: #999999;">Non défini</span>                                  th:text="'DEPT-' + ${dept.id}">                    </tr>

                        </td>

                        <td style="text-align: center;">                                DEPT-1                </thead>

                            <div style="display: inline-flex; gap: 8px;">

                                <a th:href="@{/departements/show/{id}(id=${dept.id})}"                             </span>                <tbody>

                                   class="btn btn-outline btn-sm" title="Voir les détails">

                                    <i class="fas fa-eye"></i>                        </td>                    <tr th:each="dept : ${departements}" style="border-bottom: 1px solid #F5F5F5;">

                                </a>

                                <a th:href="@{/departements/form/{id}(id=${dept.id})}"                         <td>                        <td style="padding: 16px;">

                                   sec:authorize="hasRole('CHEF_DEPT')"

                                   class="btn btn-secondary btn-sm" title="Modifier">                            <div style="font-weight: 600; color: #1A1A1A; margin-bottom: 2px;"                            <span style="font-family: 'Courier New', monospace; color: #C5A572; font-weight: 600; font-size: 14px;" 

                                    <i class="fas fa-edit"></i>

                                </a>                                 th:text="${dept.nom}">                                  th:text="'DEPT-' + ${dept.id}">DEPT-1</span>

                                <button th:onclick="'if(confirm(\'⚠️ Supprimer définitivement le département ' + ${dept.nom} + ' ?\')) { window.location.href=\'' + @{/departements/delete/{id}(id=${dept.id})} + '\'; }'"

                                        sec:authorize="hasAnyRole('ADMIN', 'RH')"                                Département                        </td>

                                        class="btn btn-secondary btn-sm" title="Supprimer">

                                    <i class="fas fa-trash"></i>                            </div>                        <td style="padding: 16px;">

                                </button>

                            </div>                            <div th:if="${dept.description != null && !#strings.isEmpty(dept.description)}"                             <div style="font-weight: 600; color: #1A1A1A; margin-bottom: 2px;" th:text="${dept.nom}">Département</div>

                        </td>

                    </tr>                                 style="font-size: 12px; color: #666666; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"                            <div th:if="${dept.description != null && !dept.description.isEmpty()}" 

                </tbody>

            </table>                                 th:text="${dept.description}">                                 style="font-size: 12px; color: #666666; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 

        </div>

                                        Description                                 th:text="${dept.description}">Description</div>

        <div th:if="${departements == null || departements.empty}" 

             style="padding: 80px 40px; text-align: center;">                            </div>                        </td>

            <i class="fas fa-building" style="font-size: 64px; color: #E0E0E0; margin-bottom: 24px;"></i>

            <h3 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #1A1A1A; margin-bottom: 12px;">                        </td>                        <td style="padding: 16px;">

                Aucun département

            </h3>                        <td>                            <div th:if="${dept.chefDepartement != null}" style="display: flex; align-items: center; gap: 12px;">

            <p style="color: #666666; margin-bottom: 24px;">

                Créez votre premier département pour organiser vos équipes                            <div th:if="${dept.chefDepartement != null}" style="display: flex; align-items: center; gap: 12px;">                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #C5A572 0%, #B39563 100%); display: flex; align-items: center; justify-content: center; font-size: 14px; color: #FFFFFF; font-weight: 600;">

            </p>

            <a th:href="@{/departements/form}" class="btn btn-primary">                                <div class="avatar"                                    <span th:text="${dept.chefDepartement.prenom.substring(0,1) + dept.chefDepartement.nom.substring(0,1)}">JD</span>

                <i class="fas fa-plus" style="margin-right: 8px;"></i>Créer un département

            </a>                                     th:text="${#strings.substring(dept.chefDepartement.prenom, 0, 1) + #strings.substring(dept.chefDepartement.nom, 0, 1)}">                                </div>

        </div>

    </div>                                    JD                                <div>

</div>

</body>                                </div>                                    <div style="font-weight: 500; color: #1A1A1A;" th:text="${dept.chefDepartement.prenom + ' ' + dept.chefDepartement.nom}">Chef</div>

</html>

                                <div>                                    <div style="font-size: 12px; color: #666666;" th:text="${dept.chefDepartement.poste}">Poste</div>

                                    <div style="font-weight: 500; color: #1A1A1A;"                                </div>

                                         th:text="${dept.chefDepartement.prenom + ' ' + dept.chefDepartement.nom}">                            </div>

                                        Jean Dupont                            <span th:if="${dept.chefDepartement == null}" style="color: #999999;">Non assigné</span>

                                    </div>                        </td>

                                    <div style="font-size: 12px; color: #666666;"                        <td style="text-align: center; padding: 16px;">

                                         th:text="${dept.chefDepartement.poste}">                            <span style="display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 36px; background: #F5F5F5; font-weight: 600; color: #1A1A1A;"

                                        Chef de département                                  th:text="${dept.employes != null ? dept.employes.size() : 0}">0</span>

                                    </div>                        </td>

                                </div>                        <td style="padding: 16px;">

                            </div>                            <span sec:authorize="hasAnyRole('ADMIN', 'RH')" th:if="${dept.budget != null && dept.budget > 0}" 

                            <span th:unless="${dept.chefDepartement != null}" style="color: #999999;">Non assigné</span>                                  style="font-weight: 600; color: #1A1A1A;"

                        </td>                                  th:text="${#numbers.formatDecimal(dept.budget, 1, 'COMMA', 0, 'POINT')} + ' €'">0 €</span>

                        <td style="text-align: center;">                            <span sec:authorize="hasAnyRole('ADMIN', 'RH')" th:if="${dept.budget == null || dept.budget == 0}" 

                            <span style="display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 36px; background: #F5F5F5; border-radius: 8px; font-weight: 600; color: #1A1A1A;"                                  style="color: #999999;">Non défini</span>

                                  th:text="${employeCountsMap != null && employeCountsMap.get(dept.id) != null ? employeCountsMap.get(dept.id) : 0}">                            <span sec:authorize="!hasAnyRole('ADMIN', 'RH')" style="color: #999999; font-style: italic;">Indisponible</span>

                                0                        </td>

                            </span>                        <td style="text-align: center; padding: 16px;">

                        </td>                            <a th:href="@{/departements/show/{id}(id=${dept.id})}" 

                        <td>                               style="color: #4299E1; text-decoration: none; margin: 0 4px;" 

                            <span sec:authorize="hasRole('EMPLOYE') or hasRole('CHEF_PROJET')"                                title="Voir">

                                  style="color: #999999; font-style: italic;">Indisponible</span>                                <i class="fas fa-eye"></i>

                            <span sec:authorize="hasAnyRole('ADMIN', 'RH', 'CHEF_DEPT')"                            </a>

                                  th:if="${dept.budget != null && dept.budget > 0}"                             <a sec:authorize="hasAnyRole('ADMIN', 'RH')"

                                  style="font-weight: 600; color: #1A1A1A;">                               th:href="@{/departements/form/{id}(id=${dept.id})}" 

                                <span th:text="${#numbers.formatDecimal(dept.budget, 1, 'COMMA', 0, 'POINT')} + ' €'">0 €</span>                               style="color: #C5A572; text-decoration: none; margin: 0 4px;" 

                            </span>                               title="Modifier">

                            <span sec:authorize="hasAnyRole('ADMIN', 'RH', 'CHEF_DEPT')"                                <i class="fas fa-edit"></i>

                                  th:if="${dept.budget == null || dept.budget == 0}"                             </a>

                                  style="color: #999999;">Non défini</span>                            <a sec:authorize="hasAnyRole('ADMIN')"

                        </td>                               href="#" 

                        <td style="text-align: center;">                               th:attr="onclick='if(confirm(\'Êtes-vous sûr de vouloir supprimer ce département ?\')) { document.getElementById(\'deleteForm' + ${dept.id} + '\').submit(); } return false;'"

                            <div style="display: inline-flex; gap: 8px;">                               style="color: #E53E3E; text-decoration: none; margin: 0 4px;" 

                                <a th:href="@{/departements/show/{id}(id=${dept.id})}"                                title="Supprimer">

                                   class="btn btn-outline btn-sm" title="Voir les détails">                                <i class="fas fa-trash"></i>

                                    <i class="fas fa-eye"></i>                            </a>

                                </a>                            <form sec:authorize="hasAnyRole('ADMIN')"

                                <a th:href="@{/departements/form/{id}(id=${dept.id})}"                                   th:id="'deleteForm' + ${dept.id}" 

                                   sec:authorize="hasRole('CHEF_DEPT')"                                  th:action="@{/departements/delete/{id}(id=${dept.id})}" 

                                   class="btn btn-secondary btn-sm" title="Modifier">                                  method="post" 

                                    <i class="fas fa-edit"></i>                                  style="display: none;">

                                </a>                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                                <button th:onclick="'if(confirm(\'⚠️ Supprimer définitivement le département ' + ${dept.nom} + ' ?\')) { window.location.href=\'' + @{/departements/delete/{id}(id=${dept.id})} + '\'; }'"                            </form>

                                        sec:authorize="hasAnyRole('ADMIN', 'RH')"                        </td>

                                        class="btn btn-secondary btn-sm" title="Supprimer">                    </tr>

                                    <i class="fas fa-trash"></i>                    <tr th:if="${#lists.isEmpty(departements)}">

                                </button>                        <td colspan="6" style="padding: 48px; text-align: center; color: #999999; font-size: 14px;">

                            </div>                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block; color: #E0E0E0;"></i>

                        </td>                            <div style="font-weight: 500; margin-bottom: 8px;">Aucun département trouvé</div>

                    </tr>                            <div style="font-size: 12px;">Créez votre premier département pour commencer</div>

                </tbody>                        </td>

            </table>                    </tr>

        </div>                </tbody>

                    </table>

        <div th:if="${departements == null || departements.empty}"         </div>

             style="padding: 80px 40px; text-align: center;">    </div>

            <i class="fas fa-building" style="font-size: 64px; color: #E0E0E0; margin-bottom: 24px;"></i></body>

            <h3 style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #1A1A1A; margin-bottom: 12px;"></html>

                Aucun département
            </h3>
            <p style="color: #666666; margin-bottom: 24px;">
                Créez votre premier département pour organiser vos équipes
            </p>
            <a th:href="@{/departements/form}" class="btn btn-primary">
                <i class="fas fa-plus" style="margin-right: 8px;"></i>Créer un département
            </a>
        </div>
    </div>
</div>
</body>
</html>
