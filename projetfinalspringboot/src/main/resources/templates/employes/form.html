<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/main}">
<head>
    <title th:text="${employe.id != null ? 'Modifier' : 'Ajouter'} + ' un Employé - RH Élégance'">Employé - RH Élégance</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Page Header -->
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>
                        <i th:classappend="${employe.id != null ? 'fa-edit' : 'fa-user-plus'}" class="fas" style="margin-right: 12px; color: #C5A572;"></i>
                        <span th:text="${employe.id != null ? 'Modifier' : 'Ajouter'} + ' un employé'">Ajouter un employé</span>
                    </h1>
                    <p class="subtitle" th:text="${employe.id != null ? 'Modifier les informations de l''employé' : 'Créer un nouveau profil employé'}">
                        Créer un nouveau profil employé
                    </p>
                </div>
                <a th:href="@{/employes/list}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Retour à la liste
                </a>
            </div>
        </div>

        <!-- Error Messages -->
        <div th:if="${error}" class="alert alert-danger">
            <i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- Sécurité : accès réservé RH, ADMIN ou l'employé lui-même -->
    <div th:if="${canViewEmploye}">
            <!-- Form -->
            <form th:action="@{${employe.id != null ? '/employes/update/' + employe.id : '/employes/create'}}" 
                  method="post" 
                  th:object="${employe}">
                
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Informations personnelles -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <i class="fas fa-user" style="margin-right: 12px;"></i>Informations personnelles
                    </div>
                    <div style="padding: 32px;">
                        <div class="grid-3" style="margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">Matricule <span style="color: #C5A572;">*</span></label>
                                <!-- En création: champ éditable -->
                                <input th:if="${employe.id == null}"
                                       type="text" 
                                       th:field="*{matricule}" 
                                       class="form-control" 
                                       placeholder="Ex: EMP001"
                                       pattern="[A-Za-z0-9_-]{3,20}"
                                       title="Le matricule doit contenir entre 3 et 20 caractères alphanumériques"
                                       required>
                                <!-- En modification: champ en lecture seule -->
                                <input th:if="${employe.id != null}"
                                       type="text" 
                                       th:field="*{matricule}" 
                                       class="form-control" 
                                       readonly>
                                <small th:if="${employe.id == null}" style="color: #666; font-size: 12px;">Le matricule doit être unique (3-20 caractères)</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Nom <span style="color: #C5A572;">*</span></label>
                                <input type="text" 
                                       th:field="*{nom}" 
                                       th:readonly="${isSelfEdit}"
                                       class="form-control" 
                                       placeholder="Nom de famille"
                                       pattern="[A-Za-zÀ-ÿ\s'-]{2,50}"
                                       title="Le nom doit contenir entre 2 et 50 lettres"
                                       minlength="2"
                                       maxlength="50"
                                       required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Prénom <span style="color: #C5A572;">*</span></label>
                                <input type="text" 
                                       th:field="*{prenom}" 
                                       th:readonly="${isSelfEdit}"
                                       class="form-control" 
                                       placeholder="Prénom"
                                       pattern="[A-Za-zÀ-ÿ\s'-]{2,50}"
                                       title="Le prénom doit contenir entre 2 et 50 lettres"
                                       minlength="2"
                                       maxlength="50"
                                       required>
                            </div>
                        </div>

                        <div class="grid-2" style="margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">Email <span style="color: #C5A572;">*</span></label>
                                <input type="email" 
                                       th:field="*{email}" 
                                       class="form-control" 
                                       placeholder="prenom.nom@entreprise.com" 
                                       required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Téléphone</label>
                                <input type="tel" 
                                       th:field="*{telephone}" 
                                       class="form-control" 
                                       placeholder="06 12 34 56 78"
                                       pattern="[0-9\s.+-]{10,20}"
                                       title="Le téléphone doit contenir entre 10 et 20 chiffres">
                            </div>
                        </div>

                        <div class="grid-2" style="margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">Date de naissance</label>
                                <input type="date" 
                                       th:field="*{dateNaissance}"
                                       th:readonly="${isSelfEdit}"
                                       class="form-control"
                                       max="2007-12-31"
                                       min="1950-01-01"
                                       title="L'employé doit avoir au moins 18 ans">
                                <small style="color: #666; font-size: 12px;">L'employé doit avoir au moins 18 ans</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Date d'embauche <span style="color: #C5A572;">*</span></label>
                                <input type="date" 
                                       th:field="*{dateEmbauche}"
                                       th:readonly="${isSelfEdit}"
                                       class="form-control" 
                                       required>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 24px;">
                            <label class="form-label">Date de fin de contrat</label>
                            <input type="date" 
                                   th:field="*{dateFin}"
                                   th:readonly="${isSelfEdit}"
                                   th:min="${employe.dateEmbauche}"
                                   class="form-control">
                            <small style="color: #666; font-size: 12px;">Optionnel - Doit être postérieure à la date d'embauche</small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Adresse</label>
                            <textarea th:field="*{adresse}" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Adresse complète"
                                      maxlength="200"
                                      pattern="[A-Za-z0-9À-ÿ\s,.'°-]{0,200}"
                                      title="Adresse invalide (max 200 caractères, pas de caractères spéciaux)"></textarea>
                        </div>

                    </div>
                </div>

                <!-- Informations professionnelles -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <i class="fas fa-briefcase" style="margin-right: 12px;"></i>Informations professionnelles
                    </div>
                    <div style="padding: 32px;">
                        <div class="grid-2" style="margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">Poste <span style="color: #C5A572;">*</span></label>
                                <input type="text" 
                                       th:field="*{poste}" 
                                       th:readonly="${isSelfEdit}"
                                       class="form-control" 
                                       placeholder="Ex: Développeur, Manager..."
                                       pattern="[A-Za-zÀ-ÿ\s'-]{2,100}"
                                       title="Le poste doit contenir entre 2 et 100 lettres"
                                       minlength="2"
                                       maxlength="100"
                                       required>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Grade</label>
                                <select th:field="*{grade}" class="form-control" th:disabled="${isSelfEdit}">
                                    <option value="">-- Sélectionner un grade --</option>
                                    <option th:each="gradeOption : ${T(com.gestionrh.projetfinalspringboot.model.enums.Grade).values()}" 
                                            th:value="${gradeOption}" 
                                            th:text="${gradeOption.libelle}">Grade</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid-3" style="margin-bottom: 24px;">
                            <div class="form-group">
                                <label class="form-label">Salaire de base <span style="color: #C5A572;">*</span></label>
                                <div style="display: flex; align-items: stretch;">
                                    <input type="number" 
                                           th:field="*{salaireBase}" 
                                           th:readonly="${isSelfEdit}"
                                           class="form-control" 
                                           step="0.01" 
                                           min="0.01"
                                           max="999999.99"
                                           placeholder="0.00" 
                                           title="Le salaire doit être positif (max 999999.99€)"
                                           required
                                           style="border-right: none;">
                                    <span style="border: 1px solid #E0E0E0; padding: 14px 16px; background: #FAFAFA; border-left: none; font-size: 14px; color: #666666;">€</span>
                                </div>
                                <small style="color: #666; font-size: 12px;">Le salaire doit être positif</small>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Département</label>
                                <select name="departementId" class="form-control" th:disabled="${isSelfEdit}"
                                        th:value="${employe.departement != null ? employe.departement.id : ''}">
                                    <option value="">-- Aucun département --</option>
                                    <option th:each="dept : ${departements}" 
                                            th:value="${dept.id}" 
                                            th:text="${dept.nom}"
                                            th:selected="${employe.departement != null && employe.departement.id == dept.id}">Département</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Manager</label>
                                <select name="managerId" class="form-control" th:disabled="${isSelfEdit}"
                                        th:value="${employe.manager != null ? employe.manager.id : ''}">
                                    <option value="">-- Aucun --</option>
                                    <option th:each="mgr : ${managers}" 
                                            th:value="${mgr.id}" 
                                            th:text="${mgr.prenom + ' ' + mgr.nom}"
                                            th:selected="${employe.manager != null && employe.manager.id == mgr.id}">Manager</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Statut <span style="color: #C5A572;">*</span></label>
                            <select th:field="*{statut}" class="form-control" th:disabled="${isSelfEdit}" required>
                                <option th:each="statutOption : ${T(com.gestionrh.projetfinalspringboot.model.enums.StatutEmploye).values()}" 
                                        th:value="${statutOption}" 
                                        th:text="${statutOption.libelle}">Statut</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="card">
                    <div style="padding: 32px; display: flex; justify-content: space-between; gap: 12px;">
                        <a th:href="@{/employes/list}" class="btn btn-secondary">
                            <i class="fas fa-times" style="margin-right: 8px;"></i>Annuler
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save" style="margin-right: 8px;"></i>
                            <span th:text="${employe.id != null ? 'Modifier' : 'Créer'} + ' l\'employé'">Créer l'employé</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
        <!-- Message accès refusé -->
    <div th:if="${!canViewEmploye}" class="alert alert-danger" style="margin-top:40px;">
            <i class="fas fa-lock" style="margin-right: 8px;"></i>
            Accès refusé : vous n'avez pas les droits pour modifier ce profil employé.
        </div>
    </div>
</body>
</html>
