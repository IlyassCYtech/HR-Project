<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security" layout:decorate="~{layout/main}" lang="fr">

<head>
    <title>Gestion des Congés - RH Élégance</title>
</head>

<body>
    <div layout:fragment="content">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin-bottom: 8px;">Gestion des Congés</h1>
                    <p class="subtitle">Vue d'ensemble des congés et absences</p>
                </div>
                <a th:href="@{/conges/form}" class="btn btn-primary">
                    <i class="fas fa-plus" style="margin-right: 8px;"></i>Nouvelle demande
                </a>
            </div>
        </div>

        <div th:if="${success}" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
            <span th:text="${success}"></span>
        </div>

        <!-- Filtres -->
        <div class="card" style="margin-bottom: 24px;">
            <div class="card-header">
                <i class="fas fa-filter" style="margin-right: 12px;"></i>Filtres
            </div>
            <form method="GET" th:action="@{/conges/list}">
                <div style="padding: 24px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
                    <div>
                        <label class="form-label" for="employeId">EMPLOYÉ</label>
                        <select id="employeId" name="employeId" class="form-control"
                            th:disabled="${!#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}">
                            <option th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}" value="">Tous
                                les employés</option>
                            <option th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}"
                                th:each="emp : ${employes}" th:value="${emp.id}" th:text="${emp.prenom + ' ' + emp.nom}"
                                th:selected="${param.employeId != null && param.employeId[0] == emp.id.toString()}">
                            </option>
                            <option th:unless="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}"
                                th:value="${#authentication.principal.username}"
                                th:text="${#authentication.principal.username}" selected>
                            </option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label" for="type">TYPE</label>
                        <select id="type" name="type" class="form-control">
                            <option value="">Tous les types</option>
                            <option value="CONGES_PAYES"
                                th:selected="${param.type != null && param.type[0] == 'CONGES_PAYES'}">Congés payés
                            </option>
                            <option value="MALADIE" th:selected="${param.type != null && param.type[0] == 'MALADIE'}">
                                Maladie</option>
                            <option value="MATERNITE"
                                th:selected="${param.type != null && param.type[0] == 'MATERNITE'}">Maternité</option>
                            <option value="PATERNITE"
                                th:selected="${param.type != null && param.type[0] == 'PATERNITE'}">Paternité</option>
                            <option value="FORMATION"
                                th:selected="${param.type != null && param.type[0] == 'FORMATION'}">Formation</option>
                            <option value="SANS_SOLDE"
                                th:selected="${param.type != null && param.type[0] == 'SANS_SOLDE'}">Sans solde</option>
                        </select>
                    </div>

                    <div>
                        <label class="form-label" for="statut">STATUT</label>
                        <select id="statut" name="statut" class="form-control">
                            <option value="">Tous les statuts</option>
                            <option value="EN_ATTENTE"
                                th:selected="${param.statut != null && param.statut[0] == 'EN_ATTENTE'}">En attente
                            </option>
                            <option value="APPROUVE"
                                th:selected="${param.statut != null && param.statut[0] == 'APPROUVE'}">Approuvé</option>
                            <option value="REFUSE" th:selected="${param.statut != null && param.statut[0] == 'REFUSE'}">
                                Refusé</option>

                        </select>
                    </div>

                    <div style="display: flex; align-items: flex-end;">
                        <button type="submit" class="btn btn-primary" style="flex: 1; margin-right: 8px;">
                            <i class="fas fa-search" style="margin-right: 8px;"></i>Filtrer
                        </button>
                        <a th:href="@{/conges/list}" class="btn btn-secondary">
                            Réinitialiser
                        </a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Liste des congés -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-calendar-check" style="margin-right: 12px;"></i>Liste des demandes de congés
            </div>

            <div th:if="${conges != null && !conges.isEmpty()}">
                <table class="table-elegant">
                    <thead>
                        <tr>
                            <th>EMPLOYÉ</th>
                            <th>TYPE</th>
                            <th>PÉRIODE</th>
                            <th style="text-align: center;">JOURS</th>
                            <th>MOTIF</th>
                            <th style="text-align: center;">STATUT</th>
                            <th style="text-align: center;">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="conge : ${conges}">
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="avatar">
                                        <span
                                            th:text="${conge.employe.prenom.substring(0,1) + conge.employe.nom.substring(0,1)}">EM</span>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #1A1A1A;"
                                            th:text="${conge.employe.prenom + ' ' + conge.employe.nom}">
                                            Jean Dupont
                                        </div>
                                        <div style="font-size: 12px; color: #666666;" th:text="${conge.employe.poste}">
                                            Poste
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td style="font-weight: 600; color: #1A1A1A;" th:text="${conge.typeConge}">CONGES_PAYES</td>
                            <td>
                                <div style="font-size: 13px; color: #1A1A1A;">
                                    <div style="margin-bottom: 4px;">
                                        <i class="fas fa-play-circle"
                                            style="color: #C5A572; margin-right: 6px; font-size: 11px;"></i>
                                        <span
                                            th:text="${#temporals.format(conge.dateDebut, 'dd/MM/yyyy')}">01/01/2024</span>
                                    </div>
                                    <div>
                                        <i class="fas fa-flag-checkered"
                                            style="color: #C5A572; margin-right: 6px; font-size: 11px;"></i>
                                        <span
                                            th:text="${#temporals.format(conge.dateFin, 'dd/MM/yyyy')}">15/01/2024</span>
                                    </div>
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <span
                                    style="display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 36px; background: #F5F5F5; border-radius: 8px; font-weight: 600; color: #1A1A1A;"
                                    th:text="${conge.nombreJours}">5</span>
                            </td>
                            <td>
                                <div
                                    style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; color: #666666;">
                                    <span th:if="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}">
                                        <span th:if="${conge.motif != null && !#strings.isEmpty(conge.motif)}"
                                            th:text="${conge.motif}">Motif</span>
                                        <span th:unless="${conge.motif != null && !#strings.isEmpty(conge.motif)}"
                                            style="color: #999999;">-</span>
                                    </span>
                                    <span th:unless="${#authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}"
                                        style="color: #999999; font-style: italic;">Confidentiel</span>
                                </div>
                            </td>
                            <td style="text-align: center;">
                                <span th:if="${conge.statut.name() == 'EN_ATTENTE'}"
                                    class="badge-elegant badge-warning">En attente</span>
                                <span th:if="${conge.statut.name() == 'APPROUVE'}"
                                    class="badge-elegant badge-success">Approuvé</span>
                                <span th:if="${conge.statut.name() == 'REFUSE'}"
                                    class="badge-elegant badge-danger">Refusé</span>
                                <span th:if="${conge.statut.name() == 'ANNULE'}"
                                    class="badge-elegant badge-secondary">Annulé</span>
                            </td>
                            <td style="text-align: center;">
                                <div style="display: inline-flex; gap: 6px; align-items: center;">
                                    <a th:href="@{/conges/show/{id}(id=${conge.id})}" class="btn btn-outline btn-sm"
                                        style="padding: 6px 10px; font-size: 13px;" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </a>

                                    <!-- Boutons pour congés EN_ATTENTE -->
                                    <div
                                        th:if="${conge.statut.name() == 'EN_ATTENTE' && #authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}">
                                        <form th:action="@{/conges/approve/{id}(id=${conge.id})}" method="post"
                                            style="display: inline; margin: 0;">
                                            <button type="submit" class="btn btn-sm"
                                                style="background: #10B981; color: white; border: 1px solid #10B981; padding: 6px 10px; font-size: 13px;"
                                                title="Approuver"
                                                onclick="return confirm('Approuver cette demande de congé ?')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        <form th:action="@{/conges/reject/{id}(id=${conge.id})}" method="post"
                                            style="display: inline; margin: 0;">
                                            <button type="submit" class="btn btn-sm"
                                                style="background: #EF4444; color: white; border: 1px solid #EF4444; padding: 6px 10px; font-size: 13px;"
                                                title="Refuser"
                                                onclick="return confirm('Refuser cette demande de congé ?')">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                    </div>

                                    <!-- Bouton pour ré-approuver un congé REFUSE -->
                                    <div
                                        th:if="${conge.statut.name() == 'REFUSE' && #authorization.expression('hasAnyRole(''ADMIN'', ''RH'')')}">
                                        <form th:action="@{/conges/approve/{id}(id=${conge.id})}" method="post"
                                            style="display: inline; margin: 0;">
                                            <button type="submit" class="btn btn-sm"
                                                style="background: #10B981; color: white; border: 1px solid #10B981; padding: 6px 10px; font-size: 13px;"
                                                title="Approuver quand même"
                                                onclick="return confirm('Approuver cette demande précédemment refusée ?')">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div th:unless="${conges != null && !conges.isEmpty()}" style="padding: 80px 40px; text-align: center;">
                <i class="fas fa-calendar-check" style="font-size: 64px; color: #E0E0E0; margin-bottom: 24px;"></i>
                <h3
                    style="font-family: 'Playfair Display', serif; font-size: 24px; font-weight: 600; color: #1A1A1A; margin-bottom: 12px;">
                    Aucune demande
                </h3>
                <p style="color: #666666; margin-bottom: 24px;">
                    Aucune demande de congé n'a été trouvée
                </p>
                <a th:href="@{/conges/form}" class="btn btn-primary">
                    <i class="fas fa-plus" style="margin-right: 8px;"></i>Nouvelle demande
                </a>
            </div>
        </div>
    </div>
</body>

</html>